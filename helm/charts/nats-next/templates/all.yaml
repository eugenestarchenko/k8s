{{- $name := include "nats.fullname" $ }}
{{- with .Values }}
{{- $_ := set .config.jetstream.fileStore.pvc   "name" (.config.jetstream.fileStore.pvc.name   | default (printf "%s-js" $name)) }}
{{- $_ := set .config.resolver.pvc              "name" (.config.resolver.pvc.name              | default (printf "%s-resolver" $name)) }}
{{- $_ := set .configMap                        "name" (.configMap.name                        | default (printf "%s-config" $name)) }}
{{- $_ := set .headlessService                  "name" (.headlessService.name                  | default (printf "%s-headless" $name)) }}
{{- $_ := set .ingress                          "name" (.ingress.name                          | default (printf "%s-ws" $name)) }}
{{- $_ := set .natsBox.contextSecret            "name" (.natsBox.contextSecret.name            | default (printf "%s-box-context" $name)) }}
{{- $_ := set .natsBox.contentsSecret           "name" (.natsBox.contentsSecret.name           | default (printf "%s-box-contents" $name)) }}
{{- $_ := set .natsBox.deployment               "name" (.natsBox.deployment.name               | default (printf "%s-box" $name)) }}
{{- $_ := set .service                          "name" (.service.name                          | default $name) }}
{{- $_ := set .statefulSet                      "name" (.statefulSet.name                      | default $name) }}
{{- $_ := set .promExporter.podMonitor          "name" (.promExporter.podMonitor.name          | default $name) }}
{{- end }}

{{- $values := get (include "tplYaml" (dict "doc" .Values "ctx" $) | fromJson) "doc" }}
{{- $_ := set $ "Values" $values -}}

---
# config-map.yaml
{{- with .Values.config }}
{{- $config := include "nats.loadMergePatch" (merge (dict "file" "config/config.yaml" "ctx" $) .) | fromYaml }}
{{- $_ := set $ "config" $config -}}
{{- end }}
{{- with .Values.configMap }}
{{- $configMap := include "nats.loadMergePatch" (merge (dict "file" "config-map.yaml" "ctx" $) .) }}
{{ $configMap }}
{{- $_ := set $ "configChecksum" (sha256sum $configMap) -}}
{{- end }}

---
# stateful-set/stateful-set.yaml
{{- with .Values.statefulSet }}
{{ include "nats.loadMergePatch" (merge (dict "file" "stateful-set/stateful-set.yaml" "ctx" $) .) }}
{{- end }}

---
# headless-service.yaml
{{- with .Values.headlessService }}
{{ include "nats.loadMergePatch" (merge (dict "file" "headless-service.yaml" "ctx" $) .) }}
{{- end }}

{{- with .Values.service }}
{{- if .enabled }}
---
# service.yaml
{{ include "nats.loadMergePatch" (merge (dict "file" "service.yaml" "ctx" $) .) }}
{{- end }}
{{- end }}

{{- with .Values.ingress }}
{{- if and .enabled .hosts $.Values.config.websocket.enabled $.Values.service.enabled }}
---
# ingress.yaml
{{ include "nats.loadMergePatch" (merge (dict "file" "ingress.yaml" "ctx" $) .) }}
{{- end }}
{{- end }}

{{- with .Values.promExporter }}
{{- if and .enabled .podMonitor.enabled }}
{{- with .podMonitor }}
---
# prom-exporter-pod-monitor.yaml
{{ include "nats.loadMergePatch" (merge (dict "file" "prom-exporter-pod-monitor.yaml" "ctx" $) .) }}
{{- end }}
{{- end }}
{{- end }}

{{- with .Values.natsBox }}
{{- if .enabled }}
{{- with .deployment}}
---
# nats-box/deployment/deployment.yaml
{{ include "nats.loadMergePatch" (merge (dict "file" "nats-box/deployment/deployment.yaml" "ctx" $) .) }}
{{- end }}
{{- with .contextSecret}}
---
# nats-box/context-secret/context-secret.yaml
{{ include "nats.loadMergePatch" (merge (dict "file" "nats-box/context-secret/context-secret.yaml" "ctx" $) .) }}
{{- end }}
{{- with .deployment}}
---
# nats-box/contents-secret.yaml
{{ include "nats.loadMergePatch" (merge (dict "file" "nats-box/contents-secret.yaml" "ctx" $) .) }}
{{- end }}
{{- end }}
{{- end }}

{{- range .Values.extraResources }}
---
# extra resource
{{ . | toYaml }}
{{- end }}
